CLOUDINARY

Cloud name  :  dznjtqpmm
API KEY : 123379161313422
API SECRET :  99ZSJtjBAmXn7cPPdl_JcNhplxI
API ENV :  CLOUDINARY_URL=cloudinary://123379161313422:99ZSJtjBAmXn7cPPdl_JcNhplxI@dznjtqpmm
MAPBOX TOKEN :  pk.eyJ1Ijoic2hhaWttdXN0YWZhNzgiLCJhIjoiY21hczMzbWY2MGg5aDJrc2E0dWhjbjByZSJ9.RY23oZdobkP2MME6CyVqCA

MONGODB:
Username :  awsanddevops29_db_user
Password :  HjgOVCRHSChlTiEG
Endpoint : “mongodb+srv://awsanddevops29_db_user:HjgOVCRHSChlTiEG@cluster0.vdsbrwt.mongodb.net/?appName=Cluster0”
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Jenkinsfile: (for Docker container)

pipeline {
    agent any
    environment {

        SCANNER_HOME = tool 'mysonar'

        CLOUDINARY_CLOUD_NAME = credentials('CLOUDINARY_CLOUD_NAME')

        CLOUDINARY_KEY = credentials('CLOUDINARY_KEY')

        CLOUDINARY_SECRET = credentials('CLOUDINARY_SECRET')

        MAPBOX_TOKEN = credentials('MAPBOX_TOKEN')

        DB_URL = credentials('DB_URL')
    }
    stages {
        stage('Git Checkout') {
            steps {

                git branch: 'main', url: 'https://github.com/devops0014/3-Tier-Full-Stack-yelp-camp.git'
            }
        }
        stage('SonarQube') {
            steps {
                withSonarQubeEnv('mysonar') {
                    sh """
                        ${SCANNER_HOME}/bin/sonar-scanner \

                        -Dsonar.projectKey=CampProject \

                        -Dsonar.projectName=CampProject
                    """
                }
            }
        }
        stage ("Quality Gates") {
            steps {
                script {
                    waitForQualityGate abortPipeline: false, credentialsId: 'sonar'
                }
            }
        }
        stage('Docker Build & Tag') {
            steps {
                script {
                    withDockerRegistry(credentialsId: 'docker-cred', toolName: 'docker') {
                        sh "docker build -t shaikmustafa/testcamp:latest ."
                    }
                }
            }
        }
        stage('Trivy Image Scan') {
            steps {
                sh "trivy image --format table -o image-report.html shaikmustafa/testcamp:latest"
            }
        }
        stage('Docker Push Image') {
            steps {
                script {
                    withDockerRegistry(credentialsId: 'docker-cred', toolName: 'docker') {
                        sh "docker push shaikmustafa/testcamp:latest"
                    }
                }
            }
        }
        stage('Docker Deploy To Local') {
            steps {
                 sh "docker run -d -p 3004:3000 \
                --name testcamp \
                -e CLOUDINARY_CLOUD_NAME=$CLOUDINARY_CLOUD_NAME \
                -e CLOUDINARY_KEY=$CLOUDINARY_KEY \
                -e CLOUDINARY_SECRET=$CLOUDINARY_SECRET \
                -e MAPBOX_TOKEN=$MAPBOX_TOKEN \
                -e DB_URL=$DB_URL \
                shaikmustafa/testcamp:latest"

            }

        }

    }
    post {
        always {
            mail to: 'awsanddevops18@gmail.com',
                 subject: "SUCCESS: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                 body: "*${currentBuild.currentResult}:* Job ${env.JOB_NAME} \n build ${env.BUILD_NUMBER} \n More info at: ${env.BUILD_URL}"
        }
    }
}

———
CREATE EKS CLUSTER WITH TERRAFORM:
———

FINAL PIPELINE: (K8S container pipeline)

pipeline {
    agent any
    environment {
        SCANNER_HOME = tool 'mysonar'
    }
    stages {
        stage('Git Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/devops0014/3-Tier-Full-Stack-yelp-camp.git'
            }
        }
        stage('SonarQube') {
            steps {
                withSonarQubeEnv('mysonar') {
                    sh """
                        ${SCANNER_HOME}/bin/sonar-scanner \
                        -Dsonar.projectKey=CampProject \
                        -Dsonar.projectName=CampProject
                    """
                }
            }
        }
        stage ("Quality Gates") {
            steps {
                script {
                    waitForQualityGate abortPipeline: false, credentialsId: 'sonar'
                }
            }
        }
        stage('Docker Build & Tag') {
            steps {
                script {
                    withDockerRegistry(credentialsId: 'docker-cred', toolName: 'docker') {
                        sh "docker build -t shaikmustafa/testcamp:latest ."
                    }
                }
            }
        }
        stage('Trivy Image Scan') {
            steps {
                sh "trivy image --format table -o image-report.html shaikmustafa/testcamp:latest"
            }
        }
        stage('Docker Push Image') {
            steps {
                script {
                    withDockerRegistry(credentialsId: 'docker-cred', toolName: 'docker') {
                        sh "docker push shaikmustafa/testcamp:latest"
                    }
                }
            }
        }
        stage('Deploy To EKS') {
            steps {
                withKubeCredentials(kubectlCredentials: [[caCertificate: '', clusterName: 'EKS_CLOUD', contextName: '', credentialsId: 'k8-token', namespace: 'webapps', serverUrl: 'https://47B6F6EF983A4ADF9932CACED98DB0A6.sk1.us-east-1.eks.amazonaws.com']]) {
                    sh "kubectl apply -f Manifests/"
                    sleep 60
                }
            }
        }
    }
    post {
        always {
            mail to: 'awsanddevops18@gmail.com',
                 subject: "PIPELINE STATUS: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                 body: "*${currentBuild.currentResult}:* Job ${env.JOB_NAME} \n build ${env.BUILD_NUMBER} \n More info at: ${env.BUILD_URL}"
        }
    }
}

---------------------------------------------------------------------------------------------------------------------------------------------------------------------
RBAC Manifest files:  This is used to communicate between eks ckuster and jenkins

vi service-account.yml
---
apiVersion: v1
kind: ServiceAccount
metadata:
 name: jenkins
 namespace: webapps

 kubectl create -f service-account.yml -n webapps


vi role.yml
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: app-role
  namespace: webapps
rules:
  - apiGroups:
      - ""
      - apps
      - autoscaling
      - batch
      - extensions
      - policy
      - rbac.authorization.k8s.io
    resources:
      - pods
      - componentstatuses
      - configmaps
      - daemonsets
      - deployments
      - events
      - endpoints
      - horizontalpodautoscalers
      - ingresses
      - jobs
      - limitranges
      - namespaces
      - nodes
      - persistentvolumes
      - persistentvolumeclaims
      - resourcequotas
      - replicasets
      - replicationcontrollers
      - serviceaccounts
      - services
      - statefulsets
      - cronjobs
      - secrets
      - limitranges
      - poddisruptionbudget 

    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]

kubectl create -f role.yml -n webapps


vi role-binding.yml

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: app-rolebinding
  namespace: webapps
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: app-role
subjects:
  - kind: ServiceAccount
    name: jenkins
    namespace: webapps

kubectl create -f role-binding.yml -n webapps

vi secret.yml
---
apiVersion: v1
kind: Secret
metadata:
  name: yelp-camp-secrets
type: Opaque
data:
  CLOUDINARY_CLOUD_NAME: ZGgxZmJqdWlpCg==
  CLOUDINARY_KEY: MTY2NDYzNTExNTQyNDYyCg==
  CLOUDINARY_SECRET: SmFzX013blhYUTF2ZFphelFqRWxuV2RqSXZFCg==
  MAPBOX_TOKEN: cGsuZXlKMUlqb2lZVzFwZEhOcGJtZG9jems0SWl3aVlTSTZJbU50T0RKbWFHTXdNREIwZG13eWFtOWtZWEUxTVRBek9Hc2lmUS5MTXc2ZTVIOHZvTFVUc3d0YUduWjlBCg==
  DB_URL: bW9uZ29kYitzcnY6Ly9hbWl0c2luZ2hzMjc5ODpDSFRVRHdEQUlsNm45MW5IQGFtaXQteWVscC42cXhtdy5tb25nb2RiLm5ldC8/cmV0cnlXcml0ZXM9dHJ1ZSZ3PW1ham9yaXR5JmFwcE5hbWU9QW1pdC1ZZWxwCg==

kubectl create -f secret.yml -n webapps
# to get secret token
kubectl describe secret mysecret -n webapps

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------

K8S application manifest files:

apiVersion: apps/v1
kind: Deployment
metadata:
  name: yelp-camp-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: yelp-camp
  template:
    metadata:
      labels:
        app: yelp-camp
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app: yelp-camp
              topologyKey: kubernetes.io/hostname
      containers:
        - name: yelp-camp-container
          image: amitsinghs98/campa:latest
          ports:
            - containerPort: 3000
          envFrom:
            - secretRef:
                name: yelp-camp-secrets
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
          readinessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 5
          livenessProbe:
            httpGet:
              path: /
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5



apiVersion: v1
kind: Service
metadata:
  name: yelp-camp-service
spec:
  type: LoadBalancer
  selector:
    app: yelp-camp
  ports:
    - port: 80
      targetPort: 3000


apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: yelp-camp-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: yelp-camp-deployment
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70


apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: yelp-camp-pdb
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: yelp-camp

apiVersion: v1
kind: ResourceQuota
metadata:
  name: yelpcamp-quota
spec:
  hard:
    pods: "20"
    requests.cpu: "4"
    requests.memory: 8Gi
    limits.cpu: "8"
    limits.memory: 16Gi


apiVersion: v1
kind: LimitRange
metadata:
  name: yelpcamp-limitrange
spec:
  limits:
    - default:
        cpu: "500m"
        memory: "512Mi"
      defaultRequest:
        cpu: "200m"
        memory: "256Mi"
      type: Container


-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Monitoring in EKS:

Install Helm:
curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash

Install Helm Repos:

helm repo add prometheus-community https://prometheus-community.github.io/helm-charts

helm repo add grafana https://grafana.github.io/helm-charts

helm repo update


Install Prometheus:

helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring \
  --create-namespace

Install Grafana:

helm install grafana grafana/grafana \
  --namespace monitoring

Expose Grafana:

kubectl patch svc grafana -n monitoring -p '{"spec": {"type": "LoadBalancer"}}'

To get Grafana Password

kubectl get secret --namespace monitoring grafana -o jsonpath="{.data.admin-password}" | base64 --decode

Prometheus cluster url :
http://prometheus-kube-prometheus-prometheus.monitoring.svc.cluster.local:9090


